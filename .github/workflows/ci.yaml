
name: Set PR Title from Branch Name

on:
  pull_request:
    branches: [main]

jobs:
  example_comment_pr:
    runs-on: ubuntu-latest
    name: An example job to comment a PR
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1
        with:
          config: "./kind-config.yaml"

      - name: Deploy k8s resources
        run: |
          kubectl apply -k manifests/ingress-controller
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=90s

          kubectl apply -k manifests/foo
          kubectl wait --namespace foo \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/name=http-echo \
            --timeout=90s

          kubectl apply -k manifests/bar
          kubectl wait --namespace bar \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/name=http-echo \
            --timeout=90s

      - name: Load test
        id: load_test
        run: |
          curl -Lo vegeta.tar.gz https://github.com/tsenart/vegeta/releases/download/v12.11.1/vegeta_12.11.1_linux_amd64.tar.gz && tar xvf vegeta.tar.gz

          results_foo=$(echo "GET http://localhost" \
          | vegeta attack -header "Host: foo.localhost" -duration=5s \
          | tee results_foo.bin \
          | vegeta report)

          echo "RESULTS_FOO<<EOF"$'\n'"$results_foo"$'\n'EOF >> "$GITHUB_OUTPUT"

          results_bar=$(echo "GET http://localhost" \
          | vegeta attack -header "Host: bar.localhost" -duration=5s \
          | tee results_bar.bin | vegeta report)

          echo "RESULTS_BAR<<EOF"$'\n'"$results_bar"$'\n'EOF >> "$GITHUB_OUTPUT"

      # Needs write permission: Settings -> Actions -> General -> Workflow permissions
      - name: Comment PR
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            Load testing of FOO service:
            ${{ steps.k8s_pods.outputs.results_foo }}

            Load testing of BAR service:
            ${{ steps.k8s_pods.outputs.results_bar }}
